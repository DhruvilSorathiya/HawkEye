## -*- coding: utf-8 -*-
<%include file="HEADER.tmpl"/>
<%
  if status == "FINISHED":
    statusy = "alert-success"
  elif status.startswith("ABORT"):
    statusy = "alert-warning"
  elif status == "CREATED" or status == "RUNNING" or status == "STARTED" or status == "STARTING" or status == "INITIALIZING":
    statusy = "alert-info"
  elif status == "ERROR-FAILED":
    statusy = "alert-danger"
  else:
    statusy = "alert-info"
  end
%>
<h2>${name}&nbsp;<span id='scanstatusbadge' class='badge ${statusy}'>${status}</span>&nbsp;<img id="loader" src="${docroot}/static/img/loader.gif"></h2>
  <div class="btn-toolbar" role="toolbar" style='padding-bottom: 10px'>
   <div class="btn-group">
      <a id='btn-status' class="btn btn-default" onClick='scanSummaryView("${id}")'><i class='glyphicon glyphicon-eye-open'></i>&nbsp;Summary</a>
      <a id='btn-correlations' class="btn btn-default" onClick='browseCorrelations("${id}")'><i class='glyphicon glyphicon-exclamation-sign'></i>&nbsp;Correlations</a>
      <a id='btn-browse' class="btn btn-default" onClick='browseEventList("${id}")'><i class='glyphicon glyphicon-th-list'></i>&nbsp;Browse</a>
      <a id='btn-graph' class="btn btn-default" onClick='graphEvents("${id}")'><i class='glyphicon glyphicon-asterisk'></i>&nbsp;Graph</a>
      <a id='btn-map' class="btn btn-default" onClick='viewGeoMap("${id}")'><i class='glyphicon glyphicon-globe'></i>&nbsp;Map</a>
      <a id='btn-info' class="btn btn-default" onClick='viewScanConfig("${id}")'><i class='glyphicon glyphicon-cog'></i>&nbsp;Scan Settings</a>
      <a id='btn-log' class="btn btn-default" onClick='viewScanLog("${id}")'><i class='glyphicon glyphicon-book'></i>&nbsp;Log</a>
    </div>
    <div class='btn-group pull-right'>
        <div id='btn-search' class='input-group pull-right'>
          <input class='form-control' id='searchvalue' type='text' placeholder='Search...' data-toggle='popover' data-html='true' data-animation='true' data-title='Usage' data-content="Supply a regular expression encapsulated in '/', e.g. <i>/searchregex/</i> or a simple wildcard search, e.g. <i>*string*</i> or an exact value, e.g. <i>string</i>.<br /><br /><b>Note</b> that the current scope is what's searched.">
            <div class='input-group-btn' style='width: 0px'> <!-- Chrome fix -->
              <button class='btn btn-primary' id='searchbutton' type='button' onClick="$('#btn-search').popover('toggle');searchDirector('${id}')">
                <i class='glyphicon glyphicon-search glyphicon glyphicon-white'></i>
              </button>
            </div>
        </div>
    </div>
        <div class="btn-group pull-right" role="group">
            <button id='btn-refresh' rel="tooltip" title="Refresh" class="btn btn-success btn-default" onClick='refresh()'><i class='glyphicon glyphicon-refresh glyphicon glyphicon-white'></i></button>
            <button id='btn-download-logs' rel="tooltip" data-title="Download Scan Logs" class="btn btn-default download-button" onClick='downloadLogs("${id}")'><i class='glyphicon glyphicon-download-alt glyphicon glyphicon-white'></i></button>
            <a id='btn-export' rel="tooltip" data-title="Export Data" class="btn btn-default dropdown-toggle download-button" data-toggle="dropdown"><i class='glyphicon glyphicon-download-alt glyphicon glyphicon-white'></i></a>
            <ul class="dropdown-menu">
              <li><a class='link' onClick='exportEventData("${id}", currentType, "csv")'>CSV</a></li>
              <li><a class='link' onClick='exportEventData("${id}", currentType, "excel")'>Excel</a></li>
            </ul>
        </div> 
        <div id='customtabview' role="group" class="btn-group pull-right">
         <a id='btn-fullview' rel="tooltip" data-title="Full Data View" class="btn btn-default active" onClick='browseUpdate("full")'><i class='glyphicon glyphicon-th glyphicon glyphicon-white'></i></a>
         <a id='btn-uniqueview' rel="tooltip" data-title="Unique Data View" class="btn btn-default" onClick='browseUpdate("unique")'><i class='glyphicon glyphicon-align-justify glyphicon glyphicon-white'></i></a>
         <a id='btn-vizview' rel="tooltip" data-title="Visualize" class="btn btn-default dropdown-toggle" data-toggle="dropdown"><i class='glyphicon glyphicon-picture glyphicon glyphicon-white'></i></a>
         <ul class="dropdown-menu">
            <li><a class='link' onClick='browseUpdate("viz-bubble-data")'>Bubble (Data Element)</a></li>
            <li><a class='link' onClick='browseUpdate("viz-bubble-source")'>Bubble (Source Data Element)</a></li>
            <li><a class='link' onClick='browseUpdate("viz-dendro")'>Discovery Path</a></li>
         </ul>
        </div>
        <div id='customvizview' class="btn-group pull-right">
         <a id='btn-random' rel="tooltip" data-title="Random Layout" class="btn btn-default active" onClick='vizUpdate("random")'><b>R</b></a>
         <a id='btn-forceatlas' rel="tooltip" data-title="Force Layout" class="btn btn-default" onClick='vizUpdate("force")'><b>F</b></a>
         <a id='btn-saveimage' rel="tooltip" data-title="Save Image" class="btn btn-default dropdown-toggle" onClick='vizUpdate("download")'><i class='glyphicon glyphicon-picture glyphicon glyphicon-white'></i></a>
        </div>
        <div id='modifyactions' role="group" class="btn-group pull-right">
            <a id='btn-setfp' rel="tooltip" data-title="Set/Unset False Positive flag" class="btn-warning btn btn-default dropdown-toggle" data-toggle="dropdown"><i class='glyphicon glyphicon-ban-circle glyphicon glyphicon-white'></i></a>
            <ul class="dropdown-menu">
                <li><a href='#' class='link' onClick='setFp(1)'>Set False Positive flag</a></li>
                <li><a href='#' class='link' onClick='setFp(0)'>Unset False Positive flag</a></li>
            </ul>
        </div>
  </div>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="${docroot}/static/node_modules/sigma/build/sigma.min.js"></script>
    <script src="${docroot}/static/node_modules/sigma/build/plugins/sigma.parsers.json.min.js"></script>
    <script src="${docroot}/static/node_modules/sigma/build/plugins/sigma.plugins.dragNodes.min.js"></script>
    <script src="${docroot}/static/node_modules/sigma/build/plugins/sigma.layout.forceAtlas2.min.js"></script>
    <script src="${docroot}/static/node_modules/sigma/build/plugins/sigma.renderers.snapshot.min.js"></script>
    <script type='text/javascript'>
        var currentType = "ALL";
        var currentTypeName = "All";
        var currentSection = "btn-browse";
        var lastSearchType = "ALL";
        var lastSearchQuery = "";
        var dataloaders = [];
        var sharedSigma = "";
        var loadersrunning = false;
        var refresh = function() { browseEventList("${id}"); }
        $('#searchvalue').popover({ 'trigger': 'focus', 'placement': 'bottom'});
        $('#searchvalue').keyup(function(event) {
            if (event.keyCode == 13) {
                $('#searchbutton').click();
            }
        });

        function switchSelectAll() {
            if (!$("#checkall")[0].checked) {
                $("input[id*=cb_]").prop('checked', false);
            } else {
                $("input[id*=cb_]").prop('checked', true);
            }
        }

        function getSelected() {
            ids = [];
            $("input[id*=cb_]").each(function(i, obj) {
                if (obj.checked) {
                    ids[ids.length] = obj.id.replace("cb_", "");
                }
            });

            return ids;
        }

        function setFp(flag) {
            sel = getSelected();
            if (sel.length == 0) {
                alertify.error("You need to select at least one record.");
                return false;
            }
            data = JSON.stringify(sel);
            $("#loader").show();
            he.fetchData('${docroot}/resultsetfp', {'id': '${id}', 'fp': flag, 'resultids': data }, function(ret) {
                $("#loader").hide();
                if (ret[0] == "SUCCESS") {
                    refresh();
                    return;
                }
                if (ret[0] == "WARNING") {
                    alertify.error(ret[1]);
                    return;
                }
                if (ret[0] == "ERROR") {
                    alertify.error("There was an error setting false positives because: " + ret[1] + "<br/>If you believe this to be an error, please log out and log back in, and if the problem repeats, report this as a bug.");
                }
            });
        }

        function navTo(target) {
            var targets = [ "btn-browse", "btn-info", "btn-log", 
                "btn-export", "btn-download-logs", "btn-viz",
                "btn-status", "btn-graph", "btn-correlations", "btn-map" ]
            for (var i = 0; i < targets.length; i++) {
                if (targets[i] == target) {
                    $("#" + targets[i]).addClass("active");
                } else {
                    $("#" + targets[i]).removeClass("active");
                }
            }

            $("#breadcrumbs").remove();
            $("#customtabview").hide();
            $("#customvizview").hide();
            $("#modifyactions").hide();
            currentSection = target
            dataloaders = []
        }

        function searchDirector(instanceId) {
            qry = $("#searchvalue").val();
            if (currentType == "ALL") {
                searchResults(instanceId, qry);
            } else {
                searchResults(instanceId, qry, currentType);
            }
        }

        function searchResults(instanceId, query, typeName) {
            // Remove pre-existing tables if they exist
            $("#scansummary-content").remove();
            $("#scanlogs-content").remove();
            navTo("btn-search");
            $("#modifyactions").hide();
            $("#loader").show();
            $("#btn-export").show();
            $("#btn-download-logs").hide();
            $("#btn-refresh").show();
            $("#btn-search").show();
            $("#scanreminder").hide();
            refresh = function() { searchResults(instanceId, query, typeName); }
            he.search(instanceId, query, typeName, function(data) {
                            lastSearchType = typeName;
                            lastSearchQuery = query;
                            var crumbs = " <ul class='breadcrumb' id='breadcrumbs'> <li><a class='link' onClick='browseEventList(\"" + instanceId + "\");'>Browse</a>";
                            crumbs += " <span class='divider'></span></li>";
                            if (typeName != null) {
                                crumbs += " <li><a class='link' onClick=";
                                crumbs += "'browseEventData(\"" + instanceId + "\",\"" + currentTypeName + "\",\"" + typeName + "\",\"full\");'>";
                                crumbs += unescape(currentTypeName) + "</a><span class='divider'></span></li>";
                            }
                            crumbs += "<li>Search results";
                            crumbs += " (" + data.length + " records)</li></ul>";

                            if (data.length == 0) {
                                var table = "<div id='scansummary-content'>&nbsp;&nbsp;No results found. Try broadening your search criteria.</div>";
                            } else {
                                var table = "<table id='scansummary-content' class='table table-bordered table-striped small tablesorter'><thead><tr>";
                                if (typeName == null) {
                                    table += "<th class='sorter-false'>Data Element Type</th>";
                                }
                                table += "<th>Data Element</th><th>Source Data Element</th><th>Source Module</th><th>Identified</th></tr></thead><tbody>";
                                for (var i = 0; i < data.length; i++) {
                                    table += "<tr>";
                                    if (typeName == null) {
                                        table += "<td><pre class='table-border-bg-inherit'>" + data[i][8] + "</pre></td>";
                                    }
                                    table += "<td><pre class='table-border-bg-inherit'>";
                                    table += he.replace_heurltag(data[i][1]);
                                    // for debug
                                    table += "</pre></td><td><pre class='table-border-bg-inherit'>";
                                    table += he.replace_heurltag(data[i][2]);
                                    table += "</pre></td><td><pre class='table-border-bg-inherit'>" + data[i][3];
                                    table += "</pre></td><td><pre class='table-border-bg-inherit'>" + data[i][0];
                                    table += "</pre></td>";
                                    table += "</tr>";
                                }
                                table += "</tbody></table>"
                            }
                            $("#loader").fadeOut(500);
                            $("#mainbody").append(crumbs + table);
                            $("#scansummary-content").tablesorter();
            });
        }

        // Visualisation
        function graphEvents(instanceId) {
            $("#log-controls").remove();
            $("#log-count-badge").remove();
            grid = "<div id='scansummary-content'><br />"
            grid += "<div class='col-md-12 graph-container' id='graph-container'></div>"
            grid += "</div>"

            $("#scansummary-content").remove();
            $("#scanlogs-content").remove();
            $("#loader").show();
            $("#btn-export").show();
            $("#btn-download-logs").hide();
            $("#btn-refresh").show();
            $("#btn-search").hide();
            $("#btn-graph").show();
            $("#scanreminder").hide();
            refresh = function() { graphEvents(instanceId); }
            navTo("btn-graph");
            $("#customvizview").show();
            $("#mainbody").append(grid);
            $("#btn-forceatlas").removeClass("active");
            $("#btn-random").addClass("active");

            sigma.renderers.def = sigma.renderers.canvas
            sigma.parsers.json("${docroot}/scanviz?id=" + instanceId + "&gexf=0", {
                container: 'graph-container'
            }, function(s) { 
                if (s.renderers[0].nodesOnScreen.length == 0) {
                    $("#graph-container").append("<div class='alert alert-danger'>Insufficient data to produce a graph.</div>");
                    $("#loader").hide();
                    return;
                }
                sharedSigma = s;
                s.settings({
                    edgeColor: 'default',
                    defaultEdgeColor: '#aaa',
                    maxNodeSize: 5
                });
                sigma.plugins.dragNodes(s, s.renderers[0])
                s.refresh()
                $("#loader").hide();
            });
        }

        function vizUpdate(method) {
            s = sharedSigma
            if (method == "force") {
                $("#btn-forceatlas").addClass("active");
                $("#btn-random").removeClass("active");
                s.startForceAtlas2();
                s.refresh();
                setTimeout(function() { s.stopForceAtlas2() }, 5000);
            }

            if (method == "random") {
                $("#btn-forceatlas").removeClass("active");
                $("#btn-random").addClass("active");
                refresh();
            }

            if (method == "download") {
                s.renderers[0].snapshot({download: true});
            }
        }

        // Scan status
        function scanSummaryView(instanceId) {
            $("#log-controls").remove();
            $("#log-count-badge").remove();
            grid = "<div id='scansummary-content'>";
            grid += "<div class='row'>";
            grid += "<div class='col-sm-7'>";
            grid += "<div class='panel panel-default'>";
            grid += "<div class='panel-heading'><i class='glyphicon glyphicon-eye-open'></i>&nbsp;&nbsp;Scan Status</div><div class='panel-body' style='padding: 5px'>";
            grid += "<div class='btn-toolbar text-center'>";
            grid += "<div class='btn-group' style='float: unset; padding: 5px'><button class='btn disabled btn-md btn-secondary' style='cursor: default;'>Total</span></button>";
            grid += "<button class='btn disabled btn-md btn-default' id='tcounter' style='cursor: default;'>?</button></div>";
            grid += "<div class='btn-group' style='float: unset; padding: 5px'><button class='btn disabled btn-md btn-secondary' style='cursor: default;'>Unique</button>";
            grid += "<button class='btn disabled btn-md btn-default' id='ucounter' style='cursor: default;'>?</button></div>";
            grid += "<div class='btn-group' style='float: unset; padding: 5px'><button class='btn disabled btn-md btn-secondary' style='cursor: default;'>Status</button>";
            grid += "<button class='btn disabled btn-md btn-default' id='status' style='cursor: default;'>?</button></div>";
            grid += "<div class='btn-group' style='float: unset; padding: 5px'><button class='btn disabled btn-md btn-secondary' style='cursor: default;'>Errors</button>";
            grid += "<button class='btn disabled btn-md btn-default' id='errors' style='cursor: default;'>?</button></div>";
            grid += "</div></div></div></div>";
            grid += "<div class='col-sm-5'>";
            grid += "<div class='panel panel-default'>";
            grid += "<div class='panel-heading'><i class='glyphicon glyphicon-exclamation-sign'></i>&nbsp;&nbsp;Correlations</div><div class='panel-body' style='padding: 5px'>";
            grid += "<div class='btn-toolbar text-center'>";
            grid += "<div class='btn-group' style='float: unset; padding: 5px'><button class='btn disabled btn-md btn-danger' style='cursor: default;'>High</span></button>";
            grid += "<button class='btn disabled btn-md btn-default' id='corr-high' style='cursor: default;'>?</button></div>";
            grid += "<div class='btn-group' style='float: unset; padding: 5px'><button class='btn disabled btn-md btn-warning' style='cursor: default;'>Medium</button>";
            grid += "<button class='btn disabled btn-md btn-default' id='corr-medium' style='cursor: default;'>?</button></div>";
            grid += "<div class='btn-group' style='float: unset; padding: 5px'><button class='btn disabled btn-md btn-primary' style='cursor: default;'>Low</button>";
            grid += "<button class='btn disabled btn-md btn-default' id='corr-low' style='cursor: default;'>?</button></div>";
            grid += "<div class='btn-group' style='float: unset; padding: 5px'><button class='btn disabled btn-md btn-success' style='cursor: default;'>Info</button>";
            grid += "<button class='btn disabled btn-md btn-default' id='corr-info' style='cursor: default;'>?</button></div>";
            grid += "</div></div></div></div></div>";
            grid += "<div class='row'><div class='col-sm-12'>";
            grid += "<div class='panel panel-default'>";
            grid += "<div class='panel-heading'><i class='glyphicon glyphicon-stats'></i>&nbsp;&nbsp;Data Types</div><div class='panel-body'>";
            grid += "<div id='vbarsummary'></div>";
            grid += "</div></div></div></div>";

            $("#scansummary-content").remove();
            $("#scanlogs-content").remove();
            $("#loader").show();
            $("#btn-export").hide();
            $("#btn-download-logs").hide();
            $("#btn-refresh").hide();
            $("#btn-search").hide();
            $("#scanreminder").show();
            navTo("btn-status");

            $("#mainbody").append(grid);

            // Collect data and populate variables for use later
            dataloaders.push(
                function() {
                    he.fetchData('${docroot}/scanstatus', {'id': instanceId}, function(data) {
                        scanName = data[0];
                        scanTarget = data[1];
                        scanStarted = data[2];
                        scanEnded = data[4];
                        scanStatus = data[5];
                        scanCorrelations = data[6];

                        $("#corr-high").html(scanCorrelations['HIGH']);
                        $("#corr-medium").html(scanCorrelations['MEDIUM']);
                        $("#corr-low").html(scanCorrelations['LOW']);
                        $("#corr-info").html(scanCorrelations['INFO']);
                    });
                }
            );

            dataloaders.push(
                function() {
                    he.fetchData('${docroot}/scanerrors', {'id': instanceId}, function(data) {
                        $("#errors").html(data.length);
                    });
                }
            );

            dataloaders.push(
                function() {
                    he.fetchData('${docroot}/scansummary', {'id': instanceId, 'by': 'type'}, function(data) {
                        scanSummary = [];
                        totalCount = 0;
                        uniqueCount = 0;
                        for (i = 0; i < data.length; i++) {
                            scanSummary[i] = {};
                            scanSummary[i].scanId = instanceId;
                            scanSummary[i].id = data[i][0];
                            scanSummary[i].name = data[i][1];
                            scanSummary[i].total = data[i][3];
                            scanSummary[i].counter = data[i][4];
                            scanSummary[i].link = function(d) { return browseEventData(d.scanId, d.name, d.id, "full"); };
                            totalCount += data[i][3];
                            uniqueCount += data[i][4];
                            scanStatus = data[i][5];
                        }

                        for (x = 0; x < i; x++) {
                            scanSummary[x].pct = scanSummary[x].counter / uniqueCount;
                        }

                        $('#ucounter').html(uniqueCount);
                        $('#tcounter').html(totalCount);
                        $('#scanstatusbadge').html(scanStatus);

                        var statusy = "";
                        if (scanStatus == "FINISHED") {
                            statusy = "alert-success";
                        } else if (scanStatus.indexOf("ABORT") >= 0) {
                            statusy = "alert-warning";
                        } else if (scanStatus == "CREATED" || scanStatus == "RUNNING" || scanStatus == "STARTED" || scanStatus == "STARTING" || scanStatus == "INITIALIZING") {
                            statusy = "alert-info";
                        } else if (scanStatus.indexOf("FAILED") >= 0) {
                            statusy = "alert-danger";
                        } else {
                            statusy = "alert-info";
                        }
                        $('#scanstatusbadge').removeClass(["alert-info", "alert-warning", "alert-danger"]).addClass(statusy);
                        $('#status').html(scanStatus);
                        $("#vbarsummary").empty();
                        if (scanSummary.length == 0) {
                          $("#vbarsummary").append("<div id='scansummary-content' class='alert alert-warning'><h4>No data.</h4>If the scan is still running this section will update shortly.</div>");
                        } else {
                          he_viz_vbar("#vbarsummary", scanSummary);
                        }
                        $("#loader").fadeOut(500);
                    });
                }
            );

            loadersrunning = true;
            for (var i = 0; i < dataloaders.length; i++) {
                dataloaders[i]();
            }
            loadersrunning = false;
        }

        // Expand the correlation list to show the events associated
        function toggleCorrelation(instanceId, correlationId) {
            if (!$("#corrwell_tr_" + correlationId).hasClass("hidden")) {
                $("#corrwell_td_" + correlationId).empty();
                $("#corrwell_tr_" + correlationId).addClass("hidden");
                $("#corricon_" + correlationId).removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-right");
                return;
            }
            he.fetchData('${docroot}/scaneventresults', { 'id': instanceId, 'correlationId': correlationId }, function(data) {
                var table = "<table id='corrcontent_'" + correlationId + "' class='table table-bordered table-striped small'>";
                table += "<thead><tr>";
                table += "<th>Data Element</th></th>";
                table += "<th>Source Data Element</th>";
                table += "<th>Source Module</th>";
                table += "<th>Identified</th>";
                table += "</tr></thead><tbody>";

                for (var i = 0; i < data.length; i++) {
                    table += "<tr>";
                    table += "<td><pre class='table-border-bg-inherit'>";
                    table += he.replace_heurltag(data[i][1]);
                    table += "</pre></td><td><pre class='table-border-bg-inherit'>";
                    table += he.replace_heurltag(data[i][2]);
                    table += "</pre></td><td><pre class='table-border-bg-inherit'>" + data[i][3];
                    table += "</pre></td><td><pre class='table-border-bg-inherit'>" + data[i][0];
                    table += "</pre></td>";
                    table += "</tr>";
                }
                table += "</tbody></table>"
                $("#corrwell_td_" + correlationId).html(table);
                $("#corrwell_tr_" + correlationId).removeClass("hidden");
                $("#corricon_" + correlationId).removeClass("glyphicon-chevron-right").addClass("glyphicon-chevron-down");
            });
        }

        // Correlation results for the scan
        function browseCorrelations(instanceId) {
            $("#scansummary-content").remove();
            $("#log-controls").remove();
            $("#log-count-badge").remove();
            $("#loader").show();
            $("#btn-search").hide();
            $("#btn-export").hide();
            $("#scanreminder").hide();
            navTo("btn-correlations");
            refresh = function() { browseCorrelations(instanceId); }
            he.fetchData('${docroot}/scancorrelations', {'id': instanceId}, function(data) {
                if (data.length == 0) {
                    table = "<div id='scansummary-content' class='alert alert-warning'><h4>No correlations.</h4>If the scan is still running please reload once it has completed.</div>";
                    $("#loader").fadeOut(500);
                    $("#mainbody").append(table);
                    he.updateTooltips();
                    return;
                }
                var table = "<table id='scansummary-content' class='table table-bordered table-striped table-condensed tablesorter small'>";
                table += "<thead><tr><th>Correlation</th><th>Risk</th><th>Data Elements</th></tr></thead><tbody>";
                for (var i = 0; i < data.length; i++) {
                    table += "<tr>";
                    table += "<td>";
                    table += "<i class='glyphicon glyphicon-chevron-right' id='corricon_" + data[i][0] + "' style='color: #999; margin-right: 5px;'></i>";
                    table += "<a style='cursor: pointer' onClick='toggleCorrelation(\"" + instanceId + "\",\"" + data[i][0] + "\")'>" + data[i][1] + "</a>&nbsp;&nbsp;";
                    table += "<i class='glyphicon glyphicon-question-sign' style='color: #ccc' rel='tooltip' data-title=\"" + data[i][5] + "\"></i>";
                    table += "</td>";
                    if (data[i][3] == "HIGH") {
                        statusy = "alert-danger";
                    }
                    if (data[i][3] == "MEDIUM") {
                        statusy = "alert-warning";
                    }
                    if (data[i][3] == "LOW") {
                        statusy = "alert-info";
                    }
                    if (data[i][3] == "INFO") {
                        statusy = "alert-success";
                    }
                    table += "<td><span class='badge " + statusy + "'>" + data[i][3] + "</span></td>";
                    table += "<td>" + data[i][7] + "</td>";
                    table += "</tr><tr class='hidden' id='corrwell_tr_" + data[i][0] + "'><td colspan=3 id='corrwell_td_" + data[i][0] + "'></td></tr>";
                }
                table += "</tbody></table>";
                $("#loader").fadeOut(500);
                $("#mainbody").append(table);
                $.tablesorter.addParser({ 
                    id: 'criticality', 
                    is: function(s) { 
                        return false; 
                    }, 
                    format: function(s) { 
                        return s.toLowerCase().replace(/high/,3).replace(/medium/,2).replace(/low/,1).replace(/info/,0); 
                    }, 
                    type: 'numeric' 
                });
                $("#scansummary-content").tablesorter({ headers: { 1: { sorter: 'criticality' } } });
                he.updateTooltips();
            });
        }

        // Logs for the scan
        var currentLogLimit = 500;
        var currentLogType = null;
        
        function viewScanLog(instanceId, limit, logType) {
            if (typeof limit === 'undefined') limit = 500;
            if (typeof logType === 'undefined') logType = null;
            
            currentLogLimit = limit;
            currentLogType = logType;
            
            $("#scansummary-content").remove();
            $("#scanlogs-content").remove();
            $("#log-controls").remove();
            $("#log-count-badge").remove();  // Remove old badge
            $("#loader").show();
            $("#btn-search").hide();
            $("#btn-export").hide();
            $("#btn-download-logs").show();
            $("#scanreminder").hide();
            navTo("btn-log");
            refresh = function() { viewScanLog(instanceId, currentLogLimit, currentLogType); }
            
            // Add pagination controls
            var controls = "<div id='log-controls' class='well well-sm' style='margin-bottom: 10px;'>";
            controls += "<div class='row'>";
            controls += "<div class='col-md-6'>";
            controls += "<label style='margin-right: 10px;'><i class='glyphicon glyphicon-list'></i> Number of Logs to Display:</label> ";
            controls += "<select id='log-limit' class='form-control' style='display:inline-block; width:auto;'>";
            controls += "<option value='100'" + (limit == 100 ? " selected" : "") + ">Latest 100 logs</option>";
            controls += "<option value='500'" + (limit == 500 ? " selected" : "") + ">Latest 500 logs</option>";
            controls += "<option value='1000'" + (limit == 1000 ? " selected" : "") + ">Latest 1,000 logs</option>";
            controls += "<option value='2000'" + (limit == 2000 ? " selected" : "") + ">Latest 2,000 logs</option>";
            controls += "<option value='5000'" + (limit == 5000 ? " selected" : "") + ">Latest 5,000 logs</option>";
            controls += "<option value='10000'" + (limit == 10000 ? " selected" : "") + ">Latest 10,000 logs</option>";
            controls += "<option value='0'" + (limit == 0 ? " selected" : "") + ">All logs (Quite Slow)</option>";
            controls += "</select>";
            controls += "</div>";
            controls += "<div class='col-md-6 text-right'>";
            controls += "<button class='btn btn-primary' onclick='applyLogFilters(\"" + instanceId + "\")'>";
            controls += "<i class='glyphicon glyphicon-refresh'></i> Load Logs</button>";
            controls += "<span style='margin-left: 10px; color: #999; font-size: 0.9em;'>";
            controls += "<i class='glyphicon glyphicon-info-sign'></i> Use dropdowns to filter by Component (200+ modules) or Type";
            controls += "</span>";
            controls += "</div>";
            controls += "</div></div>";
            $("#mainbody").append(controls);
            
            var params = {'id': instanceId, 'limit': limit};
            
            he.fetchData('${docroot}/scanlog', params, function(data) {
                // Always show ALL possible components (all modules)
                var componentOptions = [
                    'helib', 'hescan', 'hep__stor_db', 'hep__stor_stdout', 'hep_abstractapi', 'hep_abusech', 'hep_abuseipdb', 'hep_abusix',
                    'hep_accounts', 'hep_adblock', 'hep_adguard_dns', 'hep_ahmia', 'hep_alienvault', 'hep_alienvaultiprep', 'hep_apple_itunes',
                    'hep_archiveorg', 'hep_arin', 'hep_azureblobstorage', 'hep_base64', 'hep_bgpview', 'hep_binaryedge', 'hep_bingsearch',
                    'hep_bingsharedip', 'hep_binstring', 'hep_bitcoin', 'hep_bitcoinabuse', 'hep_bitcoinwhoswho', 'hep_blockchain',
                    'hep_blocklistde', 'hep_botscout', 'hep_botvrij', 'hep_builtwith', 'hep_c99', 'hep_callername', 'hep_censys',
                    'hep_certspotter', 'hep_cinsscore', 'hep_circllu', 'hep_citadel', 'hep_cleanbrowsing', 'hep_cleantalk', 'hep_clearbit',
                    'hep_cloudflaredns', 'hep_coinblocker', 'hep_commoncrawl', 'hep_comodo', 'hep_company', 'hep_cookie', 'hep_countryname',
                    'hep_creditcard', 'hep_crobat_api', 'hep_crossref', 'hep_crt', 'hep_crxcavator', 'hep_customfeed', 'hep_cybercrimetracker',
                    'hep_debounce', 'hep_dehashed', 'hep_digitaloceanspace', 'hep_dns_for_family', 'hep_dnsbrute', 'hep_dnscommonsrv',
                    'hep_dnsdb', 'hep_dnsdumpster', 'hep_dnsgrep', 'hep_dnsneighbor', 'hep_dnsraw', 'hep_dnsresolve', 'hep_dnszonexfer',
                    'hep_dronebl', 'hep_duckduckgo', 'hep_email', 'hep_emailcrawlr', 'hep_emailformat', 'hep_emailrep', 'hep_emergingthreats',
                    'hep_errors', 'hep_ethereum', 'hep_etherscan', 'hep_filemeta', 'hep_flickr', 'hep_focsec', 'hep_fortinet', 'hep_fraudguard',
                    'hep_fsecure_riddler', 'hep_fullcontact', 'hep_fullhunt', 'hep_github', 'hep_gleif', 'hep_google_tag_manager',
                    'hep_googlemaps', 'hep_googleobjectstorage', 'hep_googlesafebrowsing', 'hep_googlesearch', 'hep_gravatar',
                    'hep_grayhatwarfare', 'hep_greensnow', 'hep_grep_app', 'hep_greynoise', 'hep_greynoise_community', 'hep_h1nobbdde',
                    'hep_hackertarget', 'hep_hashes', 'hep_haveibeenpwned', 'hep_honeypot', 'hep_hosting', 'hep_hostio', 'hep_hunter',
                    'hep_hybrid_analysis', 'hep_iban', 'hep_iknowwhatyoudownload', 'hep_intelx', 'hep_intfiles', 'hep_ipapico', 'hep_ipapicom',
                    'hep_ipinfo', 'hep_ipqualityscore', 'hep_ipregistry', 'hep_ipstack', 'hep_isc', 'hep_jsonwhoiscom', 'hep_junkfiles',
                    'hep_keybase', 'hep_koodous', 'hep_leakix', 'hep_maltiverse', 'hep_malwarepatrol', 'hep_metadefender', 'hep_mnemonic',
                    'hep_multiproxy', 'hep_myspace', 'hep_nameapi', 'hep_names', 'hep_networksdb', 'hep_neutrinoapi', 'hep_numverify',
                    'hep_onioncity', 'hep_onionsearchengine', 'hep_onyphe', 'hep_openbugbounty', 'hep_opencorporates', 'hep_opendns',
                    'hep_opennic', 'hep_openphish', 'hep_openstreetmap', 'hep_pageinfo', 'hep_pastebin', 'hep_pgp', 'hep_phishstats',
                    'hep_phishtank', 'hep_phone', 'hep_portscan_tcp', 'hep_projectdiscovery', 'hep_psbdmp', 'hep_pulsedive', 'hep_punkspider',
                    'hep_quad9', 'hep_reversewhois', 'hep_ripe', 'hep_riskiq', 'hep_robtex', 'hep_s3bucket', 'hep_searchcode',
                    'hep_securitytrails', 'hep_seon', 'hep_shodan', 'hep_similar', 'hep_skymem', 'hep_slideshare', 'hep_snov', 'hep_social',
                    'hep_sociallinks', 'hep_socialprofiles', 'hep_sorbs', 'hep_spamcop', 'hep_spamhaus', 'hep_spider', 'hep_spur',
                    'hep_spyonweb', 'hep_sslcert', 'hep_stackoverflow', 'hep_stevenblack_hosts', 'hep_strangeheaders', 'hep_subdomain_takeover',
                    'hep_sublist3r', 'hep_surbl', 'hep_talosintel', 'hep_template', 'hep_textmagic', 'hep_threatcrowd', 'hep_threatfox',
                    'hep_threatjammer', 'hep_threatminer', 'hep_tldsearch', 'hep_tool_cmseek', 'hep_tool_dnstwist', 'hep_tool_nbtscan',
                    'hep_tool_nmap', 'hep_tool_nuclei', 'hep_tool_onesixtyone', 'hep_tool_retirejs', 'hep_tool_snallygaster',
                    'hep_tool_testsslsh', 'hep_tool_trufflehog', 'hep_tool_wafw00f', 'hep_tool_wappalyzer', 'hep_tool_whatweb', 'hep_torch',
                    'hep_torexits', 'hep_trashpanda', 'hep_trumail', 'hep_twilio', 'hep_twitter', 'hep_uceprotect', 'hep_urlscan', 'hep_venmo',
                    'hep_viewdns', 'hep_virustotal', 'hep_voipbl', 'hep_vxvault', 'hep_webanalytics', 'hep_webframework', 'hep_webserver',
                    'hep_whatcms', 'hep_whois', 'hep_whoisology', 'hep_whoxy', 'hep_wigle', 'hep_wikileaks', 'hep_wikipediaedits', 'hep_xforce',
                    'hep_yandexdns', 'hep_zetalytics', 'hep_zonefiles', 'hep_zoneh'
                ];
                
                // Always show all standard log types (even if not present in current data)
                var typeOptions = ['DEBUG', 'ERROR', 'INFO', 'STATUS', 'WARNING'];
                
                var table = "<div id='log-count-badge' style='margin-bottom: 10px;'><span class='badge badge-info'>" + data.length + " logs loaded</span></div>";
                table += "<table id='scanlogs-content' class='table table-bordered table-striped table-condensed small tablesorter' style='table-layout: fixed'>";
                table += "<thead><tr><th style='width:15%'>Time</th><th style='width:20%'>Component</th><th style='width:10%'>Type</th><th style='width:55%'>Event</th></tr></thead><tbody>";
                for (var i = 0; i < data.length; i++) {
                    if (data[i][2] == "ERROR") {
                        table += "<tr class='danger'>";
                    } else if (data[i][2] == "WARNING") {
                        table += "<tr class='warning'>";
                    } else {
                        table += "<tr>";
                    }
                    table += "<td>" + data[i][0] + "</td>";
                    table += "<td>" + data[i][1] + "</td>";
                    table += "<td>" + data[i][2] + "</td>";
                    table += "<td style='word-wrap: break-word;'>" + data[i][3] + "</td>";
                    table += "</tr>";
                }
                table += "</tbody></table>";
                $("#loader").fadeOut(500);
                $("#mainbody").append(table);
                
                // Initialize tablesorter with custom filter widgets (dropdowns for Component and Type)
                $("#scanlogs-content").tablesorter({
                    widgets: ["filter"],
                    widgetOptions: {
                        filter_searchDelay: 300,
                        filter_hideFilters: false,
                        filter_defaultFilter: { 1: '', 2: '' },  // Default to "All" for both dropdowns
                        filter_functions: {
                            1: true,  // Component column - use select dropdown
                            2: true   // Type column - use select dropdown
                        },
                        filter_selectSource: {
                            1: componentOptions,  // Component dropdown options
                            2: typeOptions        // Type dropdown options
                        },
                        filter_placeholder: {
                            search: 'Search...',
                            select: 'All'  // Placeholder text for dropdowns
                        }
                    }
                });
            });
        }
        
        function applyLogFilters(instanceId) {
            var limit = parseInt($('#log-limit').val());
            viewScanLog(instanceId, limit, null);
        }

        // Summary of event types and counts for a scan
        function browseEventList(instanceId) {
            currentType = "ALL";
            currentTypeName = "All";

            // Remove pre-existing tables if they exist
            $("#scansummary-content").remove();
            $("#scanlogs-content").remove();
            $("#log-controls").remove();
            $("#log-count-badge").remove();
            navTo("btn-browse");
            $("#loader").show();
            $("#btn-export").show();
            $("#btn-download-logs").hide();
            $("#btn-refresh").show();
            $("#btn-search").show();
            $("#scanreminder").hide();
            refresh = function() { browseEventList(instanceId); }
            he.fetchData('${docroot}/scansummary', {'id': instanceId, 'by': 'type'}, function(data) {
                            var table = "<table id='scansummary-content' class='table table-bordered table-striped tablesorter'>";
                            table += "<thead><tr> <th>Type</th><th>Unique Data Elements</th> <th>Total Data Elements</th><th>Last Data Element</th></tr></thead><tbody>";
                            for (var i = 0; i < data.length; i++) {
                                table += "<tr><td><a class='link' onClick='";
                                table += "browseEventData(\"${id}\", \"" + escape(data[i][1]) + "\", \"" + data[i][0] + "\", \"full\");'>";
                                table += data[i][1] + "</a></td>";
                                table += "<td>" + data[i][4] + "</td>";
                                table += "<td>" + data[i][3] + "</td>";
                                table += "<td>" + data[i][2] + "</td>";
                            }
                            table += "</tbody></table>"

                            if (data.length < 1) {
                                table = "<div id='scansummary-content' class='alert alert-warning'><h4>No data.</h4>If the scan is still running please try again soon.</div>";
                            }

                            $("#loader").fadeOut(500);
                            $("#mainbody").append(table);
                            $("#scansummary-content").tablesorter();
            });
        }

        // Detailed view of data for an event type for a scan
        function browseEventData(instanceId, eventTypeLabel, eventType, format, filterFP) {
            if (filterFP === 'undefined') {
                filterFP = false;
            }
            $("#scansummary-content").remove();
            $("#scanlogs-content").remove();
            $("#breadcrumbs").remove();
            $("#loader").show();
            navTo("btn-browse");
            $("#btn-export").show();
            $("#btn-download-logs").hide();
            $("#btn-refresh").show();
            $("#btn-search").show();
            $("#customtabview").show();
            $("#scanreminder").hide();
            currentType = eventType;
            currentTypeName = eventTypeLabel;
            refresh = function() { browseEventData(instanceId, eventTypeLabel, eventType, format, filterFP); }
            browseUpdate = function(newformat) { browseEventData(instanceId, eventTypeLabel, eventType, newformat, filterFP); }

            if (format == 'full') {
                $("#btn-fullview").addClass("active");
                $("#btn-uniqueview").removeClass("active");
                $("#btn-vizview").removeClass("active");
                $("#modifyactions").show();
                he.fetchData('${docroot}/scaneventresults', {'id': instanceId, 'eventType': eventType }, function(data) {
                            totalcount = 0;
                            fpcount = 0;
                            for (var i = 0; i < data.length; i++) {
                                totalcount++;
                                if (data[i][8] == "1") {
                                    fpcount++;
                                }
                            }
                            var crumbs = " <ul class='breadcrumb' id='breadcrumbs'> <li><a class='link' onClick='browseEventList(\"" + instanceId + "\");'>Browse</a>";
                            crumbs += " <span class='divider'></span></li> <li><a class='link' onClick=";
                            crumbs += "'browseEventData(\"" + instanceId + "\",\"" + eventTypeLabel + "\",\"" + eventType + "\",\"";
                            crumbs += format + "\", " + filterFP + ");'>";
                            crumbs += unescape(eventTypeLabel) + "</a></li>";
                            if (fpcount > 0) {
                                crumbs += "<div class='pull-right text-center'><i class='glyphicon glyphicon-ban-circle'></i>&nbsp;&nbsp;Hide " + fpcount + " False Positives: ";
                                crumbs += "<input class='vertical-align-top' type='checkbox' ";
                                crumbs += "onClick=\"browseEventData('" + instanceId + "', '" + eventTypeLabel +"', '" + eventType + "'";
                                crumbs += ",'" + format + "', ";
                                if (!filterFP) {
                                    fp = 1;
                                    ch = "";
                                } else {
                                    fp = 0;
                                    ch = "checked";
                                }
                                crumbs += fp + ")\" " + ch + "></input></div>";
                            }
                            crumbs += "</ul>";

                            var table = "<table id='scansummary-content' class='table table-bordered table-striped small tablesorter'>";
                            table += "<thead><tr>";
                            table += "<th class='text-center'><input id='checkall' type='checkbox' onClick='switchSelectAll()'></th>";
                            table += "<th>Data Element</th></th>";
                            table += "<th>Source Data Element</th>";
                            table += "<th>Source Module</th>";
                            table += "<th>Identified</th>";
                            table += "</tr></thead><tbody>";

                            for (var i = 0; i < data.length; i++) {
                                if (filterFP && data[i][8] == "1") {
                                    continue;
                                }
                                table += "<tr>";
                                table += "<td class='text-center'><input type='checkbox' id='cb_" + data[i][7] + "'>";
                                if (data[i][8] == "1") {
                                    table += "<br /><i class='glyphicon glyphicon-ban-circle' class='vertical-align-bottom' />";
                                }
                                table += "</td>";
                                table += "<td><pre class='table-border-bg-inherit'>";
                                //table += "<a href='${docroot}/entityinfo?id=" + data[i][7] + "'>" + data[i][1] + "</a>";
                                table += he.replace_heurltag(data[i][1]);
                                table += "</pre></td><td><pre class='table-border-bg-inherit'>";
                                table += he.replace_heurltag(data[i][2]);
                                table += "</pre></td><td><pre class='table-border-bg-inherit'>" + data[i][3];
                                table += "</pre></td><td><pre class='table-border-bg-inherit'>" + data[i][0];
                                table += "</pre></td>";
                                table += "</tr>";
                            }
                            table += "</tbody></table>"
                            $("#loader").fadeOut(500);
                            $("#mainbody").append(crumbs + table);
                            $("#scansummary-content").tablesorter({ headers: { 0: { sorter: false } } });
                            lastChecked = null;
                            var chkboxes = $('input[id*=cb_]');
                            chkboxes.click(function(e) {
                                if(!lastChecked) {
                                    lastChecked = this;
                                    return;
                                }

                                if(e.shiftKey) {
                                    var start = chkboxes.index(this);
                                    var end = chkboxes.index(lastChecked);

                                    chkboxes.slice(Math.min(start,end), Math.max(start,end)+ 1).prop('checked', lastChecked.checked);

                                }

                                lastChecked = this;
                            });

                });
            }

            if (format == 'unique') {
                $("#btn-uniqueview").addClass("active");
                $("#btn-fullview").removeClass("active");
                $("#btn-vizview").removeClass("active");
                if (filterFP == "0") {
                    filterFP = null;
                }
                he.fetchData('${docroot}/scaneventresultsunique', {'id': instanceId, 'eventType': eventType, 'filterfp': filterFP }, function(data) {
                            var crumbs = " <ul class='breadcrumb' id='breadcrumbs'> <li><a class='link' onClick='browseEventList(\"" + instanceId + "\");'>Browse</a>";
                            crumbs += " <span class='divider'></span></li> <li><a class='link' onClick=";
                            crumbs += "'browseEventData(\"" + instanceId + "\",\"" + eventTypeLabel + "\",\"" + eventType + "\",\"" + format;
                            crumbs += "\", " + filterFP + ");'>";
                            crumbs += unescape(eventTypeLabel) + "</a></li>";
                            crumbs += "<div class='pull-right text-center'><i class='glyphicon glyphicon-ban-circle'></i>&nbsp;&nbsp;&nbsp;&nbsp;Hide False Positives: ";
                            crumbs += "<input class='vertical-align-top' type='checkbox' ";
                            crumbs += "onClick=\"browseEventData('" + instanceId + "', '" + eventTypeLabel +"', '" + eventType + "'";
                            crumbs += ",'" + format + "', ";
                            if (!filterFP) {
                                fp = 1;
                                ch = "";
                            } else {
                                fp = 0;
                                ch = "checked";
                            }
                            crumbs += fp + ")\" " + ch + "></input></div>";
                            crumbs += "</ul>";

                            var table = "<table id='scansummary-content' class='table table-bordered table-striped small'>";
                            table += "<thead><tr> <th>Unique Data Element</th><th>Occurrences</th></tr></thead><tbody>";
                            for (var i = 0; i < data.length; i++) {
                                table += "<tr><td><pre class='table-border-bg-inherit'>";
                                table += he.replace_heurltag(data[i][0]);
                                table += "</pre></td><td>" + data[i][2] + "</td>";
                                table += "</tr>";
                            }
                            table += "</tbody></table>"
                            $("#loader").fadeOut(500);
                            $("#mainbody").append(crumbs + table);
                });
            }

            if (format.indexOf('viz') == 0) {
                $("#btn-vizview").addClass("active");
                $("#btn-fullview").removeClass("active");
                $("#btn-uniqueview").removeClass("active");

                if (format.indexOf("viz-bubble") == 0) {
                    he.fetchData('${docroot}/scaneventresults', {'id': instanceId, 'eventType': eventType }, function(data) {
                        var crumbs = " <ul class='breadcrumb' id='breadcrumbs'> <li><a class='link' onClick='browseEventList(\"" + instanceId + "\");'>Browse</a>";
                        crumbs += " <span class='divider'>;</span></li> <li><a class='link' onClick=";
                        crumbs += "'browseEventData(\"" + instanceId + "\",\"" + eventTypeLabel + "\",\"" + eventType + "\",\"" + format + "\");'>";
                        crumbs += unescape(eventTypeLabel) + "</a></li></ul>";
                        itemList = []
                        for (var i = 0; i < data.length; i++) {
                            if (format == "viz-bubble-source") {
                                itemList.push(he.remove_heurltag(data[i][2]));
                            }
                            if (format == "viz-bubble-data") {
                                itemList.push(he.remove_heurltag(data[i][1]));
                            }
                        }
                        $("#loader").fadeOut(500);
                        $("#mainbody").append(crumbs + "<div id='scansummary-content' class='text-center'></div>");
                        he_viz_bubble("#scansummary-content", itemList)
                    });
                }

                if (format == "viz-dendro") {
                    he.fetchData("${docroot}/scanelementtypediscovery", {'id': instanceId, 'eventType': eventType }, function(data) {
                        var crumbs = " <ul class='breadcrumb' id='breadcrumbs'> <li><a class='link' onClick='browseEventList(\"" + instanceId + "\");'>Browse</a>";
                        crumbs += " <span class='divider'></span></li> <li><a class='link' onClick=";
                        crumbs += "'browseEventData(\"" + instanceId + "\",\"" + eventTypeLabel + "\",\"" + eventType + "\",\"" + format + "\");'>";
                        crumbs += unescape(eventTypeLabel) + "</a></li></ul>";

                        $("#loader").fadeOut(500);
                        $("#mainbody").append(crumbs + "<div id='scansummary-content' class='text-center'></div>");
                        he_viz_dendrogram("#scansummary-content", data);
                    });
                }
            }
        }

        function downloadLogs(instanceId) {
            $("#loader").show();
            he.log("Loading logs for scan: " + instanceId);
            var efr = document.getElementById('exportframe');
            var urlBase = '${docroot}/scanexportlogs?id=';
            efr.src = urlBase + instanceId;
            $("#loader").fadeOut(500);
        }

        // Download the data currently being viewed
        function exportEventData(instanceId, eventType, fileType) {
            $("#loader").show();
            var efr = document.getElementById('exportframe');
            if (currentSection == "btn-search") {
                if (lastSearchType == null || lastSearchType == "ALL") {
                    type = "";
                } else {
                    type = lastSearchType;
                }
                if (fileType == "excel") {
                    var urlBase = '${docroot}/scansearchresultexport?filetype=excel&id=';
                } else {
                    var urlBase = '${docroot}/scansearchresultexport?id=';
                }
                efr.src = urlBase + instanceId + '&eventType=' + type + "&value=" + lastSearchQuery;
            }

            if (currentSection == "btn-browse") {
                if (fileType == "excel") {
                    var urlBase = '${docroot}/scaneventresultexport?filetype=excel&id=';
                } else {
                    var urlBase = '${docroot}/scaneventresultexport?id=';
                }
                efr.src = urlBase + instanceId + '&type=' + eventType;
            }

            if (currentSection == "btn-graph") {
                he.log("Loading visualisation for scan: " + instanceId);
                efr.src = '${docroot}/scanviz?id=' + instanceId + '&gexf=1';
            }

            $("#loader").fadeOut(500);
        }

        // View geographical map of data points
        function viewGeoMap(instanceId) {
            $("#scansummary-content").remove();
            $("#scanlogs-content").remove();
            $("#log-controls").remove();
            $("#log-count-badge").remove();
            $("#loader").show();
            $("#btn-export").hide();
            $("#btn-download-logs").hide();
            $("#btn-refresh").show();
            $("#btn-search").hide();
            $("#scanreminder").hide();
            navTo("btn-map");
            refresh = function() { viewGeoMap(instanceId); }
            
            he.fetchData('${docroot}/scangeodata', {'id': instanceId}, function(data) {
                var mapContainer = "<div id='scansummary-content'>";
                mapContainer += "<div class='row'>";
                mapContainer += "<div class='col-md-12'>";
                mapContainer += "<div class='panel panel-default'>";
                mapContainer += "<div class='panel-heading'><i class='glyphicon glyphicon-globe'></i>&nbsp;&nbsp;Geographical Distribution</div>";
                mapContainer += "<div class='panel-body'>";
                
                if (data.unique_count === 0) {
                    mapContainer += "<div class='alert alert-info'><h4>No geographical data available.</h4>";
                    mapContainer += "This scan did not collect any location information. ";
                    mapContainer += "Location data is typically gathered from IP addresses and other network-related information.</div>";
                } else {
                    mapContainer += "<div class='alert alert-success'>";
                    mapContainer += "<strong>Found " + data.unique_count + " unique location(s)</strong> ";
                    mapContainer += "(" + data.total_count + " total data points)";
                    mapContainer += "</div>";
                    mapContainer += "<div id='map-container' style='height: 600px; width: 100%; border: 1px solid #ddd; border-radius: 4px;'></div>";
                    mapContainer += "<div style='margin-top: 15px;'>";
                    mapContainer += "<h4>Location Details</h4>";
                    mapContainer += "<table class='table table-bordered table-striped'>";
                    mapContainer += "<thead><tr><th>Location</th><th>Occurrences</th><th>Coordinates</th></tr></thead>";
                    mapContainer += "<tbody>";
                    
                    for (var i = 0; i < data.locations.length; i++) {
                        var loc = data.locations[i];
                        mapContainer += "<tr>";
                        mapContainer += "<td>" + loc.location + "</td>";
                        mapContainer += "<td>" + loc.count + "</td>";
                        if (loc.coordinates) {
                            mapContainer += "<td>" + loc.coordinates.lat.toFixed(4) + ", " + loc.coordinates.lon.toFixed(4) + "</td>";
                        } else {
                            mapContainer += "<td><span class='text-muted'>Not geocoded</span></td>";
                        }
                        mapContainer += "</tr>";
                    }
                    
                    mapContainer += "</tbody></table>";
                    mapContainer += "</div>";
                }
                
                mapContainer += "</div></div></div></div></div>";
                
                $("#loader").fadeOut(500);
                $("#mainbody").append(mapContainer);
                
                // Initialize the map if we have location data
                if (data.unique_count > 0) {
                    var map = L.map('map-container').setView([20, 0], 2);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                        maxZoom: 18,
                    }).addTo(map);
                    
                    var markers = [];
                    var bounds = [];
                    
                    // Add markers for each location
                    for (var i = 0; i < data.locations.length; i++) {
                        var loc = data.locations[i];
                        if (loc.coordinates) {
                            var marker = L.marker([loc.coordinates.lat, loc.coordinates.lon]).addTo(map);
                            
                            var popupContent = "<strong>" + loc.location + "</strong><br>";
                            popupContent += "Occurrences: " + loc.count + "<br>";
                            popupContent += "Coordinates: " + loc.coordinates.lat.toFixed(4) + ", " + loc.coordinates.lon.toFixed(4);
                            
                            marker.bindPopup(popupContent);
                            markers.push(marker);
                            bounds.push([loc.coordinates.lat, loc.coordinates.lon]);
                        }
                    }
                    
                    // Fit map to show all markers
                    if (bounds.length > 0) {
                        if (bounds.length === 1) {
                            map.setView(bounds[0], 8);
                        } else {
                            map.fitBounds(bounds, {padding: [50, 50]});
                        }
                    }
                }
            });
        }

        // View the configuration that was used for this scan
        function viewScanConfig(instanceId) {
            $("#scansummary-content").remove();
            $("#scanlogs-content").remove();
            $("#log-controls").remove();
            $("#log-count-badge").remove();
            $("#loader").show();
            $("#btn-export").hide();
            $("#btn-download-logs").hide();
            $("#btn-refresh").show();
            $("#btn-search").hide();
            $("#scanreminder").hide();
            navTo("btn-info");
            refresh = function() { viewScanConfig(instanceId); }
            he.fetchData('${docroot}/scanopts', {'id': instanceId}, function(data) {
                table = "<div id='scansummary-content'>";
                table += "<h4>Meta Information</h4>";
                table += "<table class='table table-bordered table-striped'>";
                table += "<tr><td>Name:</td><td>" + data['meta'][0] + "</td></tr>";
                table += "<tr><td>Internal ID:</td><td>${id}</td></tr>";
                table += "<tr><td>Target:</td><td>" + data['meta'][1] + "</td></tr>";
                table += "<tr><td>Started:</td><td>" + data['meta'][3] + "</td></tr>";
                table += "<tr><td>Completed:</td><td>" + data['meta'][4] + "</td></tr>";
                table += "<tr><td>Status:</td><td>" + data['meta'][5] + "</td></tr>";
                table += "</table>";
                table += "<h4>Global Settings</h4>";
                table += "<table class='table table-bordered table-striped' style='table-layout: fixed'>";
                table += "<thead><tr><th>Option</th><th>Value</th></tr></thead><tbody>";
                for (var key in data['config']) {
                    if (key.indexOf(":") > 0) {
                        continue;
                    }
                    table += "<tr><td width=100%>" + data['configdesc'][key] + "</td><td>" + data['config'][key] + "</td></tr>";
                }
                table += "</table>";
                table += "<h4>Module Settings</h4>";
                table += "<div class='table-responsive'><table class='table table-bordered table-striped' style='table-layout: fixed'>";
                table += "<thead><tr><th>Module</th> <th>Option</th> <th>Value</th></tr></thead><tbody>";
                keys = [];
                for (var key in data['config']) {
                    keys.push(key);
                }
                keys_s = keys.sort();

                for (var i = 0; i < keys_s.length; i++) {
                    key = keys_s[i];
                    if (key.indexOf(":") > 0) {
                        bits = key.split(":");
                        table += "<tr><td>" + bits[0] + "</td><td>" + data['configdesc'][key] + "</td><td>" + data['config'][key] + "</td></tr>";
                    }
                }
                table += "</table></div></div>";

                $("#loader").fadeOut(500);
                $("#mainbody").append(table);
            });
        }

        if ("${status}" == "CREATED" || "${status}" == "RUNNING" || "${status}" == "STARTING" || "${status}" == "STARTED" || "${status}" == "UNKNOWN" || "${status}" == "INITIALIZING") {
            scanSummaryView("${id}");
        } else {
            browseEventList("${id}");
        }

        var refreshSummaryInterval;

        refreshSummary = function() {
            var status = document.getElementById("scanstatusbadge").innerHTML;

            if (status == "ERROR-FAILED" || status == "FINISHED" || status == "ABORTED") {
                he.log("Scan is " + status);
                clearInterval(refreshSummaryInterval);
                return;
            }

            he.log("Scan is " + status + ". Refreshing scan summary ...");

            for (var i = 0; i < dataloaders.length; i++) {
                if (!loadersrunning) {
                    loadersrunning = true;
                    dataloaders[i]();
                    loadersrunning = false;
                }
            }
        }

        refreshSummaryInterval = setInterval(refreshSummary, 5000);

    </script>
<iframe class="hidden" id='exportframe'></iframe>
<%include file="FOOTER.tmpl"/>
